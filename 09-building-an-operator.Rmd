# Building an operator app: general procedure

Here we will learn through a concrete example how to create an R operator for Tercen. Our goal is to create an operator performing a __linear regression__ on our input data and returning the slope and intercept of the model.

## Designing the operator {-}

The first step is to define our __input projection__ and __output relation__. In Tercen, each operator shall take as input a table and return a table. Remember:

> "__Table in, table out!__"

The **operator model** can be seen as follow: 

<center><img src="./images/R_operator_example_MODEL.png" width=500></img></center>

## Setting up the project {-}

Make sure that `tercen-studio` is properly set up and that both `Tercen` and `RStudio` run locally (respectively on http://127.0.0.1:5402 and http://127.0.0.1:8787/). Otherwise, please refer to __Chapter 2__.

**1. Create a GitHub repository from a template**

__Create a new GitHub repository__ with your own account based on the Tercen R operator template (https://github.com/tercen/templateR_operator). Click on the green button __Use this template__ in the Tercen template repository.

<center><img src="./images/R_operator_example_SETUP2.png" width=1000></img></center>

Then you can create your own repository based on this template. Choose an explicit name.

Now that the repository is initiated in your GitHub account, __go back to RStudio Server__ (http://127.0.0.1:8787/). __Create a new project__ by clicking on File > New project > Version control > Git. 

You will be asked the URL of the repository (put the newly created one) and a name for the project. Now, your local project should include the skeleton:

* `main.R`: main operator script

* `workspace.R`: local testing script

* `operator.json`: operator metadata

* `README_template.md`: operator documentation template

* `doc` directory: includes a `dev_commands.md` file, which contains useful development command lines.


**2. Set up the Tercen input projection**

First, start Tercen locally (http://127.0.0.1:5402) and set up the desired projection with a data step.

Note that the data step URL includes this pattern: `/w/WORKFLOWID/ds/DATASTEPID`, where `WORKFLOWID` and `DATASTEPID` are __unique workflow and data step identifiers__, respectively. These identifiers will be used in the next step within RStudio to get data from this data step.

## Coding and testing the operator locally {-}

Now that our RStudio project and Tercen projection are set up, we can code and test our operator locally as follow:

* Open `workspace.R`

* Replace the data step and workflow IDs taken from the Tercen data step URL in `workspace.R`:

```r
library(tercen)
library(dplyr)

options("tercen.workflowId" = "WORKFLOWID")
options("tercen.stepId"     = "DATASTEPID")
```

* Code your operator.

```r
do.task <- function(df) {
  # Code performing your task
}

ctx <- tercenCtx()  %>%          # Get data from the data step
  select(.x, .y, .ri, .ci) %>%   # select variables of interest
  group_by(.ri, .ci) %>%         # group by row and column ("per cell")
  do(do.task(.)) %>%             # do the task
  ctx$addNamespace() %>%         # add namespace
  ctx$save()                     # push results back to Tercen using the API
```

* __Execute the code__ and __check the results__ in Tercen

Note that we recommend to implement the following __sanity checks__ when creating an operator:

* check the presence of __expected inputs__ 

* use the __`try()` function__ to test the main function implemented (here, `lm()`)

## Documenting the operator {-}

Edit the `README.md` to describe the operator design and usage. The documentation should contain:

* A __general description__ of the operator

* A description of the __input projections__

* A description of the __output relations__

## Preparing some unit testing {-}

It's always good to prepare some unit tests that could be ran when a new version of Tercen is released.

To include a test, you need to __create a `test` subdirectory__ in your project directory. It must include:

* a test __input file__

* an expected __output file__

* a __`JSON` file__ containing information about the test


## Deploying the operator {-}

**1. Copy the code to the main.R script**

Once you are confident enough that your operator is working after testing it locally, you can copy the code to the `main.R` file.

Make sure not to include the `options()` calls that are only needed during the local development step:

```r
# The following lines shall not be included into main.R:
options("tercen.workflowId" = "wwww")
options("tercen.stepId"     = "dddd")

getOption("tercen.workflowId")
getOption("tercen.stepId")
```

**2. Initiate renv**

The ability to run an operator with exactly the same packages you used when you developed is essential for reproducible science. In order to ensure reproducibility, you can associate packages and their versions to your operator by using the `init()` function of the `renv` package: 

```r
renv::init()
```

This will initiate a project-local environment with a private R library in the `renv` subdirectory.

**3. Push it to your GitHub repository**

Once everything is ready, you simply need to push all the modifications to the GitHub repository that you created before.

If you want to install it directly from `Tercen`, you will need to [create a release in GitHub](https://help.github.com/en/github/administering-a-repository/managing-releases-in-a-repository). All the operators apps are version controlled.

All __operator apps__ who are on a git repository are installable, only the git URL and a tag version number is required for a researcher to install it in Tercen.

**4. Notify community**

Currently, we ask you to send an email to info@tercen.com containing the description and link to the __operators app__ git repository, Tercen support will manually test it and add it to the __app-library__ and thus allowing others to access it. We are currently building an web entry point for researchers to browse all the apps offered by the community.


<center>![](images/goldfish.png)</center>
